<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>SteadyStateVR</title>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Extras: animation mixer + nav helpers -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <!-- Look-at so NPC tracks the camera a bit -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- HUD -->
  <div id="loadingScreen">
    <div>Loading SteadyStateVR</div>
    <div class="pulse">Please wait…</div>
  </div>

  <div id="hint" class="hud-top">
    Quest: point with controller ray & pull trigger. Desktop: drag to look, WASD to move.<br/>
    Voice: <b>Enable Microphone</b> → <b>Speak Now</b>. Otherwise, choose an on-panel option.
  </div>

  <!-- Offscreen canvas for saving feedback card as PNG -->
  <canvas id="exportCanvas" width="880" height="560"></canvas>

  <a-scene
    background="color: #D2B48C"
    webxr="requiredFeatures: local-floor; optionalFeatures: hand-tracking"
    loading-screen="enabled: false"
    vr-mode-ui="enabled: true"
  >
    

    <!-- Camera rig + cursor + controller rays -->
    <a-entity id="rig" position="0 2.2 3.3">
      <a-entity id="camera" camera look-controls wasd-controls="acceleration: 10">
        <a-entity
          id="gazeCursor"
          cursor="fuse:false"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
          material="color: #e2e8f0; shader: flat; opacity: .85"
          raycaster="objects: .clickable"
        ></a-entity>
      </a-entity>
      <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .clickable; far: 9;"></a-entity>
      <a-entity id="leftHand"  laser-controls="hand: left"  raycaster="objects: .clickable; far: 9;"></a-entity>
    </a-entity>

    <!-- Lighting + floor -->
    <a-entity light="type: hemisphere; color: #fff; groundColor: #223; intensity: 1.0"></a-entity>
    <a-entity geometry="primitive: plane; width: 36; height: 36" rotation="-90 0 0"
              material="color: #101827; roughness: 1"></a-entity>

    <!-- Hover dot for ray hits -->
    <a-entity id="hoverDot" geometry="primitive: sphere; radius: 0.01"
              material="color: #93c5fd" visible="false"></a-entity>

    <a-assets>
    <!-- Student models -->
    <a-asset-item id="studentA" src="models/StudentB.glb"></a-asset-item>
    <a-asset-item id="studentB" src="models/StudentB.glb"></a-asset-item>
    <a-asset-item id="studentC" src="models/StudentC.glb"></a-asset-item>
  </a-assets>

  <!-- Students in the scene -->
  <a-entity id="StudentA" gltf-model="#studentA" position="-0.8 0 -2.2" rotation="0 165 0" scale="0.78 0.78 0.78" animation-mixer="clip: Idle; loop: repeat" look-at="#camera"> </a-entity>
  <a-entity id="StudentB" gltf-model="#studentB" position="-1.4 0 -2.2" rotation="0 165 0" scale="0.78 0.78 0.78" animation-mixer="clip: Idle; loop: repeat" look-at="#camera"> </a-entity>
  <a-entity id="StudentC" gltf-model="#studentC" position="1.4 0 -2.2" rotation="0 165 0" scale="0.78 0.78 0.78" animation-mixer="clip: Idle; loop: repeat" look-at="#camera"> </a-entity>

  <!-- Text UI -->
  <a-entity id="dialogueBox" text="value: ; width: 4; wrapCount: 40;" position="0 2 -2"></a-entity>

  <!-- Options UI -->
  <a-entity id="options" visible="false">
    <a-plane id="opt1" position="-1 1 -2" width="1.8" height="0.5" color="#333"></a-plane>
    <a-plane id="opt2" position="0 1 -2" width="1.8" height="0.5" color="#333"></a-plane>
    <a-plane id="opt3" position="1 1 -2" width="1.8" height="0.5" color="#333"></a-plane>

    <a-entity id="opt1text" text="value: ; align: center; wrapCount: 20;" position="-1 1 -1.9"></a-entity>
    <a-entity id="opt2text" text="value: ; align: center; wrapCount: 20;" position="0 1 -1.9"></a-entity>
    <a-entity id="opt3text" text="value: ; align: center; wrapCount: 20;" position="1 1 -1.9"></a-entity>
  </a-entity>

  <!-- Feedback screen -->
  <a-plane id="feedback" position="0 1.5 -2" width="3.5" height="2" color="#111" visible="false">
    <a-entity id="feedbackText" text="value: ; wrapCount: 40;" position="0 0 0.1"></a-entity>
  </a-plane>
  </a-scene>

  <script>
const dialogue = [
  { who:"Narrator", line:"An elementary school class is on a field trip at the local history museum. A student becomes frustrated because other students in the class were able to see exhibits that they weren’t able to. Others begin to tease the student over this, and they become agitated." },
  { who:"A", line:"It’s not fair! Everyone else got to see the dinosaur exhibit, and I didn’t!" },
  { who:"B", line:"Maybe you were too slow! You always miss stuff." },
  { who:"A", line:"Stop it! I didn’t miss it on purpose!" },
  { who:"C", line:"Yeah, maybe if you paid attention for once!" },
];

const options = [
  { label:"Option 1: Direct scolding", outcome:[
    {who:"A", line:"Why are you yelling at me?? IT'S NOT MY FAULT."},
    {who:"B", line:"Ooohhh, now you're in trouble..."},
  ], feedback:"Scolding escalated things. In real life, short calm boundaries work better."},

  { label:"Option 2: Step aside & empathize", outcome:[
    {who:"A", line:"I just wanted to see it like everyone else. Can we pass through the exhibits quickly on our way back?"},
  ], feedback:"Great choice. Empathy plus redirecting the energy de-escalates."},

  { label:"Option 3: Ignore", outcome:[
    {who:"B", line:"Yo crybaby, stop whining."},
    {who:"C", line:"Even the teacher doesn't care about you."},
    {who:"A", line:"Leave me alone! I said stop!"},
  ], feedback:"Ignoring leaves the student unprotected. Next time, intervene calmly but clearly."},
];

const dlgBox = document.querySelector('#dialogueBox');
const optsUI = document.querySelector('#options');
const opt1 = document.querySelector('#opt1text');
const opt2 = document.querySelector('#opt2text');
const opt3 = document.querySelector('#opt3text');
const feedbackBox = document.querySelector('#feedback');
const feedbackText = document.querySelector('#feedbackText');

let step=0;

function showDialogue(line){
  dlgBox.setAttribute('text','value', line);
}

function nextDialogue(){
  if(step < dialogue.length){
    showDialogue(dialogue[step].who+": "+dialogue[step].line);
    step++;
    setTimeout(nextDialogue, 3500); // auto advance every 3.5s
  }else{
    showOptions();
  }
}

function showOptions(){
  optsUI.setAttribute('visible','true');
  opt1.setAttribute('text','value', options[0].label);
  opt2.setAttribute('text','value', options[1].label);
  opt3.setAttribute('text','value', options[2].label);
}

function pickOption(i){
  optsUI.setAttribute('visible','false');
  dlgBox.setAttribute('text','value','');
  let seq = options[i].outcome;
  let idx=0;
  function runOutcome(){
    if(idx < seq.length){
      showDialogue(seq[idx].who+": "+seq[idx].line);
      idx++;
      setTimeout(runOutcome, 3500);
    }else{
      showFeedback(options[i].feedback);
    }
  }
  runOutcome();
}

function showFeedback(msg){
  dlgBox.setAttribute('text','value','');
  feedbackBox.setAttribute('visible','true');
  feedbackText.setAttribute('text','value',msg);
}

document.querySelector('#opt1').addEventListener('click', ()=>pickOption(0));
document.querySelector('#opt2').addEventListener('click', ()=>pickOption(1));
document.querySelector('#opt3').addEventListener('click', ()=>pickOption(2));

document.addEventListener('DOMContentLoaded', ()=>setTimeout(nextDialogue, 1000));
</script>
</body>
</html>