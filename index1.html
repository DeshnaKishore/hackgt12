<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>SteadyStateVR</title>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Extras: animation mixer + nav helpers -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <!-- Look-at so NPC tracks the camera a bit -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <!-- (Optional) STT polyfill for desktop; Quest usually lacks STT -->
  <script src="https://cdn.jsdelivr.net/npm/speech-recognition-polyfill@0.1.4/dist/speech-recognition.min.js"></script>

  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal safety styling if style.css is empty */
    #loadingScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000a;color:#e5f3ff;font:16px/1.4 system-ui,Segoe UI,Roboto,sans-serif;z-index:2}
    .hud-left{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;flex-direction:column;z-index:3}
    .hud-top{position:fixed;top:12px;left:50%;transform:translateX(-50%);color:#dbeafe;background:#0b1222cc;padding:.5rem .75rem;border-radius:.5rem;z-index:3;font-size:.9rem}
    .btn2d{background:#0b2545;color:#e6f1ff;border:1px solid #18324d;padding:.5rem .75rem;border-radius:.5rem}
    .status{color:#9fb6d1}
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="loadingScreen">
    <div>
      <div style="font-size:20px;margin-bottom:.25rem">Loading SteadyStateVR</div>
      <div class="pulse" style="opacity:.8">Please wait…</div>
    </div>
  </div>

  <div class="hud-left">
    <button id="micPermission" class="btn2d">Enable Microphone</button>
    <button id="speakNow" class="btn2d" disabled>Speak Now (1s)</button>
    <div id="micStatus" class="status">Microphone: Disabled</div>
  </div>

  <div id="hint" class="hud-top">
    Quest: point with controller ray & pull trigger. Desktop: drag to look, WASD to move.<br/>
    Voice: <b>Enable Microphone</b> → <b>Speak Now</b>. Otherwise, choose an on-panel option.
  </div>

  <!-- Offscreen canvas for saving feedback card as PNG -->
  <canvas id="exportCanvas" width="880" height="560" style="display:none"></canvas>

  <a-scene
    background="color: #0b0f17"
    webxr="requiredFeatures: local-floor; optionalFeatures: hand-tracking"
    loading-screen="enabled: false"
    vr-mode-ui="enabled: true"
  >
    <!-- Camera rig + cursor + controller rays -->
    <a-entity id="rig" position="0 1.6 2.2">
      <a-entity id="camera" camera look-controls wasd-controls="acceleration: 10">
        <a-entity
          id="gazeCursor"
          cursor="fuse:false"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
          material="color: #e2e8f0; shader: flat; opacity: .85"
          raycaster="objects: .clickable"
        ></a-entity>
      </a-entity>
      <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .clickable; far: 9;"></a-entity>
      <a-entity id="leftHand"  laser-controls="hand: left"  raycaster="objects: .clickable; far: 9;"></a-entity>
    </a-entity>

    <!-- Lighting + floor -->
    <a-entity light="type: hemisphere; color: #fff; groundColor: #223; intensity: 1.0"></a-entity>
    <a-entity geometry="primitive: plane; width: 36; height: 36" rotation="-90 0 0"
              material="color: #101827; roughness: 1"></a-entity>

    <!-- ==== NPCs FOR THE SCHOOL MUSEUM SCENE ==== -->
    <!-- Student A (frustrated) -->
    <a-entity id="studentA"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/RobotExpressive/glTF-Binary/RobotExpressive.glb"
      position="-1.2 0 -3.4" rotation="0 30 0" scale="0.75 0.75 0.75"
      animation-mixer="clip: Idle; loop: repeat"
      look-at="#camera">
      <a-entity position="0 1.4 0" text="value: Student A; color:#c7d2fe; align:center; width:2"></a-entity>
    </a-entity>

    <!-- Student B (teasing) -->
    <a-entity id="studentB"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb"
      position="0 0 -3.8" rotation="0 0 0" scale="0.95 0.95 0.95"
      animation-mixer="clip: idle; loop: repeat"
      look-at="#camera">
      <a-entity position="0 1.6 0" text="value: Student B; color:#c7d2fe; align:center; width:2"></a-entity>
    </a-entity>

    <!-- Student C (joining in) -->
    <a-entity id="studentC"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Fox/glTF-Binary/Fox.glb"
      position="1.2 0 -3.6" rotation="0 -20 0" scale="0.04 0.04 0.04"
      animation-mixer="clip: Run; loop: repeat"
      look-at="#camera">
      <a-entity position="0 7.5 0" text="value: Student C; color:#c7d2fe; align:center; width:2"></a-entity>
    </a-entity>

    <!-- Teacher -->
    <a-entity id="teacher"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Avocado/glTF-Binary/Avocado.glb"
      position="0 0 -2.4" rotation="0 180 0" scale="28 28 28"
      look-at="#camera">
      <a-entity position="0 0.25 0" text="value: Teacher; color:#a7f3d0; align:center; width:2"></a-entity>
    </a-entity>

    <!-- Hover dot for ray hits -->
    <a-entity id="hoverDot" geometry="primitive: sphere; radius: 0.01"
              material="color: #93c5fd" visible="false"></a-entity>

    <!-- ==== UI PANEL (Center) ==== -->
    <a-entity id="uiPanel" position="0 1.12 -1.1">
      <a-entity geometry="primitive: plane; width: 1.52; height: 1.02"
                material="color: #071426; opacity: .96; side: double"></a-entity>

      <a-entity id="subtitle" position="-0.72 0.36 0.01"
                text="value: ; color: #e7edf7; width: 1.38; wrapCount: 44; align: left"></a-entity>
      <a-entity id="youSaid" position="-0.72 0.19 0.01"
                text="value: ; color: #9fb6d1; width: 1.38; wrapCount: 44; align: left"></a-entity>

      <!-- Choices -->
      <a-entity id="opt1" class="clickable option"
                geometry="primitive: plane; width: 1.38; height: 0.12"
                position="0 -0.02 0.01" material="color: #0d203a">
        <a-entity id="opt1text" position="-0.68 0 0"
          text="value: ; color: #e5efff; width: 1.28; wrapCount: 40; align: left"></a-entity>
      </a-entity>
      <a-entity id="opt2" class="clickable option"
                geometry="primitive: plane; width: 1.38; height: 0.12"
                position="0 -0.22 0.01" material="color: #0c1b31">
        <a-entity id="opt2text" position="-0.68 0 0"
          text="value: ; color: #dbeafe; width: 1.28; wrapCount: 40; align: left"></a-entity>
      </a-entity>
      <a-entity id="opt3" class="clickable option"
                geometry="primitive: plane; width: 1.38; height: 0.12"
                position="0 -0.42 0.01" material="color: #0a1627">
        <a-entity id="opt3text" position="-0.68 0 0"
          text="value: ; color: #c7d2fe; width: 1.28; wrapCount: 40; align: left"></a-entity>
      </a-entity>
    </a-entity>

    <!-- ==== FEEDBACK / NARRATION CARD ==== -->
    <a-entity id="feedbackCard" visible="false" position="0 1.12 -0.95" scale="0 0 0">
      <a-entity geometry="primitive: plane; width: 1.52; height: 1.02"
                material="color: #00152b; opacity: .98; side: double"></a-entity>
      <a-entity id="cardTitle" position="-0.72 0.34 0.01"
                text="value: ; color: #a7f3d0; width: 1.38; wrapCount: 44; align: left"></a-entity>
      <a-entity id="cardBody" position="-0.72 0.06 0.01"
                text="value: ; color: #e7edf7; width: 1.38; wrapCount: 44; align: left"></a-entity>
      <a-entity id="btnReplay" class="clickable"
                geometry="primitive: plane; width: 0.62; height: 0.12"
                position="0 -0.34 0.01" material="color: #0b2b33">
        <a-entity text="value: Replay; color:#d1fae5; width: 0.56; align: center"></a-entity>
      </a-entity>
    </a-entity>

    <!-- ======= Inline Logic for this scenario only ======= -->
    <script>
      // Utility: set text quickly
      const T = (sel, value) => document.querySelector(sel).setAttribute('text', 'value', value);

      const loading = document.getElementById('loadingScreen');
      window.addEventListener('load', () => {
        setTimeout(() => loading.style.display = 'none', 300); // small fade-out
      });

      // SCRIPTED DIALOGUE (first ~30s)
      const scriptedLines = [
        { who: "Student A (frustrated)", line: "It’s not fair! Everyone else got to see the dinosaur exhibit, and I didn’t!" },
        { who: "Student B (teasing)",     line: "Maybe you were too slow! You always miss stuff." },
        { who: "Student A",               line: "Stop it! I didn’t miss it on purpose!" },
        { who: "Student C (joining in)",  line: "Yeah, maybe if you paid attention for once!" }
      ];

      // Choices (exactly as requested)
      const choices = [
        { id: "opt1", text: "Yell at the frustrated student", outcome: {
            title: "Outcome: Escalation",
            body: "After you yell at the student, they become even more frustrated and begin lashing out at other students and back at you."
          }
        },
        { id: "opt2", text: "Separate the student from the class", outcome: {
            title: "Outcome: De-escalation",
            body: "You separate the student from the class. The student feels more comfortable in a safer environment with just the teacher."
          }
        },
        { id: "opt3", text: "Ignore the situation", outcome: {
            title: "Outcome: Neglect",
            body: "You ignore the situation. Others continue to tease and the student becomes more agitated and lashes out at the students."
          }
        }
      ];

      // Narration segments (~45s + 45s)
      const narrationBlocks = [
        {
          title: "Zooming out of Quest Pro",
          body:
            "“This is what you’re being trained to handle when you use our innovative de-escalation VR tool, SteadyStateVR.”\n\n" +
            "[Other situations play in silence]\n\n" +
            "“Inspired by our professional lives (going through countless minutes of harassment trainings for new hires), " +
            "we aimed to create an interactive approach to the dilemma plaguing every new hire: boring, long, often outdated, and seldom entertaining training videos.”"
        },
        {
          title: "How SteadyStateVR Works",
          body:
            "“In each of these simulated situations, you are placed in escalating situations and choices are given to test your skills, challenge your judgement, and interact with your environment in real time.”\n\n" +
            "“After bits of dialogue displaying conflict, choices will pop up in the world, prompting you to respond to the situation logically or illogically, if you choose to do so. " +
            "Your responses will be judged with a cutting-edge AI framework that provides you with personalized feedback helping you gauge whether you improved the situation or added fuel to the fire.”\n\n" +
            "“You name it—peer-pressure, theft, annoying children. Conflict resolution is a life-saving skill. " +
            "Using SteadyState will bring you to a calm medium where conflict resolution is just another skill in your toolbox.”"
        }
      ];

      const subtitle = document.getElementById('subtitle');
      const youSaid = document.getElementById('youSaid');
      const feedbackCard = document.getElementById('feedbackCard');
      const cardTitle = document.getElementById('cardTitle');
      const cardBody = document.getElementById('cardBody');
      const btnReplay = document.getElementById('btnReplay');

      // Fill in choice text
      T('#opt1text', choices[0].text);
      T('#opt2text', choices[1].text);
      T('#opt3text', choices[2].text);

      // Prevent overlaps: NPCs are far back and UI is close; also no subtitles at bottom
      // Step through scripted lines, then unlock choices
      let lineIndex = 0;
      let showingChoices = false;

      function showNextLine() {
        if (lineIndex < scriptedLines.length) {
          const seg = scriptedLines[lineIndex++];
          T('#youSaid', `${seg.who}:`);
          T('#subtitle', seg.line);
        } else {
          // show choices cue
          T('#youSaid', "Teacher (you):");
          T('#subtitle', "Choose how you respond to the situation.");
          showingChoices = true;
        }
      }

      // Auto-advance the 4 lines every ~6s (~24s total), then present choices
      showNextLine();
      const lineTimer = setInterval(() => {
        if (!showingChoices) {
          showNextLine();
        } else {
          clearInterval(lineTimer);
        }
      }, 6000);

      // Click handling for options
      choices.forEach(c => {
        const el = document.getElementById(c.id);
        el.addEventListener('click', () => {
          if (!showingChoices) return;
          presentOutcome(c.outcome.title, c.outcome.body);
        });
      });

      function presentOutcome(title, body) {
        // Show outcome card
        feedbackCard.setAttribute('visible', true);
        feedbackCard.setAttribute('animation__in', {
          property: 'scale', to: '1 1 1', dur: 280, easing: 'easeOutCubic'
        });
        T('#cardTitle', title);
        T('#cardBody', body + "\n\n(Next: narration)");
        // Queue the two narration blocks (~45s, then another ~45s)
        setTimeout(() => showNarration(0), 2200);
      }

      function showNarration(idx) {
        if (idx >= narrationBlocks.length) return;
        const n = narrationBlocks[idx];
        T('#cardTitle', n.title);
        T('#cardBody', n.body + (idx < narrationBlocks.length - 1 ? "\n\n(Continuing…)" : ""));
        // Advance after ~45s to the next narration block
        setTimeout(() => showNarration(idx + 1), 45000);
      }

      btnReplay.addEventListener('click', () => {
        // Reset state
        feedbackCard.setAttribute('animation__out', {
          property: 'scale', to: '0 0 0', dur: 220, easing: 'easeInCubic'
        });
        setTimeout(() => {
          feedbackCard.setAttribute('visible', false);
          lineIndex = 0;
          showingChoices = false;
          T('#youSaid', '');
          T('#subtitle', '');
          showNextLine();
          const t = setInterval(() => {
            if (!showingChoices) showNextLine();
            else clearInterval(t);
          }, 6000);
        }, 240);
      });

      // Basic hover dot feedback for rays
      const hoverDot = document.getElementById('hoverDot');
      ['opt1','opt2','opt3','btnReplay'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('mouseenter', evt => {
          const p = el.object3D.getWorldPosition(new THREE.Vector3());
          hoverDot.setAttribute('position', `${p.x} ${p.y} ${p.z + 0.02}`);
          hoverDot.setAttribute('visible', true);
        });
        el.addEventListener('mouseleave', () => hoverDot.setAttribute('visible', false));
      });

      // Mic UI (stubbed)
      document.getElementById('micPermission').addEventListener('click', () => {
        document.getElementById('micStatus').textContent = 'Microphone: (demo) Enabled';
        document.getElementById('speakNow').disabled = false;
      });
      document.getElementById('speakNow').addEventListener('click', () => {
        T('#youSaid', "You (voice):");
        T('#subtitle', "(Voice demo) — use on-panel choices for now.");
      });
    </script>
  </a-scene>
</body>
</html>
